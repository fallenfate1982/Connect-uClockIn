
<html>

<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    
    <!-- This is a wide open CSP declaration. To lock this down for production, see below. -->
    
    
     <meta http-equiv="Content-Security-Policy" content="
                            default-src * data: blob: ws: wss: gap://ready file://*;
                            style-src * 'unsafe-inline'; 
                            script-src * 'unsafe-inline' 'unsafe-eval';
                            connect-src * ws: wss:;">
   
   
    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <title>uClockIn</title>
    
    
    
    <link href="lib/ionic/css/ionic.css" rel="stylesheet"/>
    
    <link href="css/style.css" rel="stylesheet"/>
    <link href="css/responsive.css" rel="stylesheet"/>
    
    <link rel="stylesheet" href="themes/ej.mobile.all.min.css" />
    <!--Sample StyleSheet-->
    <link rel="stylesheet" href="themes/SampleBrowser.css" />
    <link rel="stylesheet" href="themes/SampleStyle.css" />
    
      <script type="text/javascript" src="scripts/jquery-2.1.4.min.js"></script>
   <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    
    <script src="Scripts/datajs-1.1.3.min.js"></script>
    <script src="js/q.js"></script>
    <script src="jaydata.js"></script>
    <script src="jaydatamodules/qDeferred.js"></script>
    
    <script src="scripts/ej.mobile.all.min.js"></script>

    
    
    <script type="text/javascript">
        app.initialize();
        
        
    </script>
    <script>
	    
	    
     var TAEntities;
     var BasicTimeAttendanceLog;
     var BasicTAUser;
     	
     	
     function doDBStuff(){
        $data.defaults.disableBatch = true;
        
        
        (function (global, $data, undefined) {
            $data.defaults.disableBatch = true;
                        registerEdmTypes();

            BasicTimeAttendanceLog = $data.Entity.extend("BasicTimeAttendanceLog", {
                'Id': { type: "int", key: true, computed: true },
                'UserId': { type: 'Edm.String', nullable: false, required: true},
                'Mode': { type: 'Edm.String', nullable: false, required: true},
                'DeviceId': { type: 'Edm.String', nullable: true},
                'LogTime': { type: 'Edm.DateTime', nullable: true },
                'IsCheckIn': { type: 'Edm.Boolean', nullable: false },
                'Dirty': { type: 'Edm.Boolean', nullable: false }
            });
            BasicTAUser = $data.Entity.extend("BasicTAUser", {
                'Id': { type: "int", key: true, computed: false },
                'UserName': { type: 'Edm.String', nullable: false, required: true},
                'UserPIN': { type: 'Edm.String', nullable: false, required: true},
                'Details': { type: 'Edm.String', nullable: true }
            });
                TAEntities = $data.EntityContext.extend("TAEntities", {
                    BasicTimeAttendanceLogs: { type: $data.EntitySet, elementType: BasicTimeAttendanceLog },
                    BasicTAUsers: { type: $data.EntitySet, elementType: BasicTAUser }
            });

        })(window, $data);

        $(function () {
           

            var oProviderConfig = {
                name: 'webApi',
                apiUrl: 'http://192.168.2.128/stdapi',
                disableBatch :true
            };
            //initialize the Northwind context from the static data model generated by JaySvcUtil.exe
            window['TADB'] = new TAEntities(oProviderConfig);
            window['TADBLocal'] = new TAEntities({ name: "sqLite", databaseName: "LocalDB" });
            TADBLocal.onReady(function () {
                TADB.BasicTimeAttendanceLogs.toArray(renderLogs);
                TADB.BasicTAUsers.toArray(renderUsers);
            });
        });
	}
	
	function registerEdmTypes() {

                function Edm_Boolean() { };
                $data.Container.registerType('Edm.Boolean', Edm_Boolean);
                $data.Container.mapType(Edm_Boolean, $data.Boolean);

                function Edm_Binary() { };
                $data.Container.registerType('Edm.Binary', Edm_Binary);
                $data.Container.mapType(Edm_Binary, $data.Blob);

                function Edm_DateTime() { };
                $data.Container.registerType('Edm.DateTime', Edm_DateTime);
                $data.Container.mapType(Edm_DateTime, $data.Date);

                function Edm_DateTimeOffset() { };
                $data.Container.registerType('Edm.DateTimeOffset', Edm_DateTimeOffset);
                $data.Container.mapType(Edm_DateTimeOffset, $data.Integer);

                function Edm_Time() { };
                $data.Container.registerType('Edm.Time', Edm_Time);
                $data.Container.mapType(Edm_Time, $data.Integer);

                function Edm_Decimal() { };
                $data.Container.registerType('Edm.Decimal', Edm_Decimal);
                $data.Container.mapType(Edm_Decimal, $data.Number);

                function Edm_Single() { };
                $data.Container.registerType('Edm.Single', Edm_Single);
                $data.Container.mapType(Edm_Single, $data.Number);

                function Edm_Double() { };
                $data.Container.registerType('Edm.Double', Edm_Double);
                $data.Container.mapType(Edm_Double, $data.Number);

                function Edm_Guid() { };
                $data.Container.registerType('Edm.Guid', Edm_Guid);
                $data.Container.mapType(Edm_Guid, $data.String);

                function Edm_Int16() { };
                $data.Container.registerType('Edm.Int16', Edm_Int16);
                $data.Container.mapType(Edm_Int16, $data.Integer);

                function Edm_Int32() { };
                $data.Container.registerType('Edm.Int32', Edm_Int32);
                $data.Container.mapType(Edm_Int32, $data.Integer);

                function Edm_Int64() { };
                $data.Container.registerType('Edm.Int64', Edm_Int64);
                $data.Container.mapType(Edm_Int64, $data.Integer);

                function Edm_Byte() { };
                $data.Container.registerType('Edm.Byte', Edm_Byte);
                $data.Container.mapType(Edm_Byte, $data.Integer);

                function Edm_String() { };
                $data.Container.registerType('Edm.String', Edm_String);
                $data.Container.mapType(Edm_String, $data.String);

            };


	
        function renderLogs(dataList) {
            var table = $('#categoryTable tbody');
            table.empty();
            dataList.forEach(function (item) {
                table.append('<tr><td><a onClick="loadProduct(' + item.Id + ')">' +
                    item.Id + '</a></td><td>' + item.UserId + '</td></tr>');
            });
        }
        
        function renderUsers(dataList) {
            var table = $('#userTable tbody');
            table.empty();
            dataList.forEach(function (item) {
                table.append('<tr><td><a onClick="loadProduct(' + item.UserName + ')">' +
                    item.UserName + '</a></td><td>' + item.Id + '</td></tr>');
            });
        }
        

        function testSaveLocal() {
			var today = new Date();
			var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
            var _log = new BasicTimeAttendanceLog({UserId: "2", Mode: "1", DeviceId: "1", LogTime: date,Dirty:"true" });
            TADBLocal.BasicTimeAttendanceLogs.add(_log);
            TADBLocal.BasicTimeAttendanceLogs.saveChanges();
        }

        function clearTimeLogs() {
            TADBLocal.BasicTimeAttendanceLogs.forEach(function (item) { TADBLocal.BasicTimeAttendanceLogs.remove(item); });
            TADBLocal.saveChanges();

        }
        function sync() {
            // we'll only try to sync if API is available
            $.ajax('http://192.168.2.128', {
                   statusCode: {
                   404: function() {
                       //alert('Not working');
                   },
                   200: function() {
                       TADBLocal.BasicTimeAttendanceLogs
                       .filter("it.Dirty == true")
                       .toArray(function (items) {
                                recSync(items,0);
                                });
                   
                       // Sync Users
                       resetUsers();
                       reloadUsers();
                   }
                   }
            });
        }

        function recSync(items, i) {
            if (i < items.length) {
                TADB.add(items[i]);
                TADB.saveChanges(function () {
                    TADBLocal.attachOrGet(items[i]);
                    items[i].Dirty = false;
                    TADBLocal.saveChanges(recSync(items, i + 1));
                });
            }
        }
    
        // Loads the new Users from the remote DB
        function reloadUsers(){
            var _users = TADB.BasicTAUsers.toArray(function(dataList){
		       // Use the Q library to make calls syncranous
             Q.fcall(function(){
                     TADBLocal.addMany(dataList);
                     }).then(function(){
                             TADBLocal.saveChanges(function(){
                                                   TADBLocal.BasicTAUsers.toArray(renderUsers);
                                                   });
                             });
                    });
        }
        // Clears the local DB of T and A Users
         function resetUsers() {
            TADBLocal.BasicTAUsers.forEach(function (item) { 
	            TADBLocal.BasicTAUsers.remove(item); 
	            TADBLocal.saveChanges();
	            });
        }
// Get the autorization token for making requests
function getToken(callback, errorCb) {
    var url = "http://192.168.2.128/token";
    var uname = "atsl";
    var pass = "Password123#";
    
    $.ajax({
            url: url,
            data: "grant_type=password&username="+uname+"&password="+pass,
            type: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded", "Cache-Control": "no-cache", "If-Modified-Since": "Mon, 27 Mar 1972 00:00:00 GMT" },
            dataType: "json",
            success:function (result) {
               localStorage.setItem('access_token', result.access_token); // set local storage
               // set header for future requests by JayData
               TADB.prepareRequest = function(cfg){
                   cfg.headers["Authorization"] = "Bearer "+localStorage.getItem("access_token");
                   cfg.headers["Content-Type"] = "application/json; charset=utf-8";
                   cfg.headers["Cache-Control"] = "no-cache";
                   cfg.headers["If-Modified-Since"] = "Mon, 27 Mar 1972 00:00:00 GMT";
               };
                if (callback != null)
                    callback(result.response, result.status, uname);
            },
            error:function (result) {
                if (errorCb)
                errorCb(result.status);
            }
        }
    );
}
    </script>

</head>

<body>
    <table id="categoryTable" class="table span3 reset-m" style="margin: 0 10px 10px 0 !important;">
        <thead>
            <tr>
                <th>Category name</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    
    <table id="userTable" class="table span3 reset-m" style="margin: 0 10px 10px 0 !important;">
        <thead>
            <tr>
                <th>User name</th>
                <th>PIN</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>


    <div id="loginPageCtrl" >
					<div class="MainWrapper">
				<div class="SplashWrapper">
					<div class="outerLogin">
						<div id="SpLogoLogin">
							<div class="innerLogin">
								<img src="img/sp_logo.png" />
							</div>
						</div>
					</div>
					<div class="clear"></div>
					
					<div class="LoginFromWrapper">
						<h2> Login 5</h2>
						<div class="LoginFrom">
							
							<label for="username"> Username:
								<div style="width: 100%;" class="ForIpad">
									<i class="icon ion-android-person placeholder-icon CustomIconCss"></i>
									<input type="text" id="username" data-role="ejmdropdownlist" data-ej-datasource="window.listData"
								            data-ej-watermarktext="Select nationality" data-ej-fields-text="name" data-ej-fields-image="image" />
								</div> </label>
								
							<label for="password"> Password:
								<div style="width: 100%;" class="ForIpad">
									<i class="icon ion-ios-locked placeholder-icon CustomIconCss"></i>
									<input  type="password" id="password" />
								</div> </label>
							<div class="clear"></div>
							<div ng-click="doLogin()" class="LoginButton">
								Login
							</div>
						</div>
					</div>
				</div>
			</div>
			</div>
</body>
<script>
								        window.listData = [{ name: "Australia", image: "themes/sampleimages/countries/Australia.png" },
								                           { name: "Brazil", image: "themes/sampleimages/countries/Brazil.png" },
								                           { name: "China", image: "themes/sampleimages/countries/china.png" },
								                           { name: "India", image: "themes/sampleimages/countries/India.png" },
								                           { name: "Spain", image: "themes/sampleimages/countries/Spain.png" },
								                           { name: "United States of America", image: "themes/sampleimages/countries/Usa.png" }
								        ];
								    </script>
</html>
